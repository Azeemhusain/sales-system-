<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sales Entry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body class="bg-gray-100 min-h-screen p-10">   
<div class="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
  <h2 class="text-xl font-bold mb-4 text-center">Sales Calculations</h2>

  <!-- ✅ One Single Form for Insert + Update -->
  <form method="POST" action="/" id="salesForm" class="space-y-4" onsubmit="return validateForm()">
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-gray-700 font-medium mb-1">Quantity</label>
        <input type="text" name="quantity" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" oninput="calculations()">
      </div>
      <div>
        <label class="block text-gray-700 font-medium mb-1">Unit Price</label>
        <input type="text" name="unit_price" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" oninput="calculations()">
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-gray-700 font-medium mb-1">Sales Date</label>
        <input type="date" name="sale_date" value="{{ today_date }}" max="{{ max_date }}" class="w-full p-2.5 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
      </div>
      <div>
        <label class="block text-gray-700 font-medium mb-1">Total Price</label>
        <input type="text" name="total_price" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" readonly>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-gray-700 font-medium mb-1">Sales ID</label>
        <input type="text" name="sales_id" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
      </div>
      <div>
        <label class="block text-gray-700 font-medium mb-1">Cash Received</label>
        <input type="text" name="cash_received" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" oninput="leftpayment()">
      </div>
    </div>

    <div>
      <label class="block text-gray-700 font-medium mb-1">Remaining Amount</label>
      <input type="text" name="remaining_amount" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" readonly>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <select name="product_name" id="product_name" required class="border p-2 rounded-lg">
        <option value="">Select Product</option>
        {% for p in users %}
          <option value="{{ p[0] }}">{{ p[1] }}</option>
        {% endfor %}
      </select>

      <select name="User" id="User" required class="border p-2 rounded-lg">
        <option value="">Select User</option>
        {% for u in user %}
          <option value="{{ u[0] }}">{{ u[1] }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- ✅ Save / Update Button -->
    <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
      Save
    </button>
  </form>
</div>

<!-- Sales List -->
<div class="bg-white p-6 mx-auto rounded-xl shadow-lg mt-9 max-w-2xl">
  <h1 class="text-2xl font-bold mb-6 text-center">Sales Records</h1>
  <div class="space-y-4">
    {% for s in sales %}
      <div class="flex justify-between items-center bg-gray-50 p-4 rounded-lg shadow-sm">
        <div>
          <span class="text-lg font-medium text-gray-800">Quantity: {{ s[0] }}</span>
          <span class="block text-sm text-gray-600">Unit Price: {{ s[1] }}</span>
          <span class="block text-sm text-gray-600">Total Price: {{ s[2] }}</span>   
          <span class="block text-sm text-gray-600">Sale Date: {{ s[3] }}</span>
          <span class="block text-sm text-gray-600">Cash Received: {{ s[4] }}</span>
          <span class="block text-sm text-gray-600">Sales ID: {{ s[6] }}</span>  
          <span class="block text-sm text-gray-600">Remaining Amount: {{ s[5] }}</span> 
          <span class="block text-sm text-gray-600">User: {{ s[9] }}</span>  
          <span class="block text-sm text-gray-600">Product: {{ s[10] }}</span> 
        </div>

        <!-- ✅ Update & Delete -->
        <div class="flex gap-2">
          <button type="button" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition text-sm"
            onclick="fillForm('{{ s[6] }}', '{{ s[0] }}', '{{ s[1] }}', '{{ s[2] }}', '{{ s[3] }}', '{{ s[4] }}', '{{ s[5] }}', '{{ s[7] }}', '{{ s[8] }}')">
            Update
          </button>

          <form action="/delete/{{ s[6] }}" method="POST">
            <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition text-sm">
              Delete
            </button>
          </form>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<script>
function calculations() {
  const q = document.getElementsByName("quantity")[0].value || 0;
  const p = document.getElementsByName("unit_price")[0].value || 0;
  document.getElementsByName("total_price")[0].value = (q * p).toFixed(2);
}

function leftpayment() {
  const total = document.getElementsByName("total_price")[0].value || 0;
  const received = document.getElementsByName("cash_received")[0].value || 0;
  document.getElementsByName("remaining_amount")[0].value = (total - received).toFixed(2);
}

function validateForm() {
  const fields = ["quantity", "unit_price", "sale_date", "total_price", "cash_received", "remaining_amount"];
  for (let f of fields) {
    if (document.getElementsByName(f)[0].value.trim() === "") {
      alert(`${f} must be filled out`);
      return false;
    }
  }
  return true;
}

// ✅ Auto-fill form for update
function fillForm(id, qty, unit, total, date, cash, remain, productId, userId) {
  document.getElementsByName("sales_id")[0].value = id;
  document.getElementsByName("quantity")[0].value = qty;
  document.getElementsByName("unit_price")[0].value = unit;
  document.getElementsByName("total_price")[0].value = total;
  document.getElementsByName("sale_date")[0].value = date;
  document.getElementsByName("cash_received")[0].value = cash;
  document.getElementsByName("remaining_amount")[0].value = remain;
  document.getElementById("product_name").value = productId;
  document.getElementById("User").value = userId;

  const form = document.getElementById("salesForm");
  const button = document.getElementById("submitBtn");
  form.action = `/updatesales/${id}`;  // ✅ Switch to update route
  button.textContent = "Update";
  button.classList.remove("bg-blue-600");
  button.classList.add("bg-yellow-600");
}
</script>
</body>
</html>
